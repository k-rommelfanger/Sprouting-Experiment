---
title: "Test Analysis"
author: "Kaitlin Rommelfanger"
date: "2025-12-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Cleaning Data}
library(readr)
library(tidyverse)

#removed the two reps where intake radicle length was 10 in excel prior to import, this length is impossible 

sprout <- read_csv("Sprouting Experiment/data/E1 LARA_AVGE intake experiment Fall 2022 - MasterData.csv")

sprout<-sprout%>%filter(`IntakeDate`!="11/7/22")#remove the one random intake on 11/7 

##replace the <0.01 with 0.005 (essentially <RL is changed to half of the reporting limit)
sprout$`IntakeRadicleLength-cm`[sprout$`IntakeRadicleLength-cm`=="<0.1"]<-0.005

#change all NA to 0, in intake radical length
sprout$`IntakeRadicleLength-cm`[is.na(sprout$`IntakeRadicleLength-cm`)] <- 0


#split the tray number and treatment type into two separate columns so I can plot separately 
sprout<-sprout%>%separate(`Tray ID`, into = c("Treatment","Tray Number"), sep = " ")

#write an if else statement to make sprouted or not 0 or 1
#sprouted-1
#not sprouted-0
sprout$sprouted<-ifelse(sprout$SproutDate=="NA",'0','1')

#made not sprouted NA instead of 0, so changing NA to 0 in sprouted column
sprout$sprouted[is.na(sprout$sprouted)]<-0

#changing how STEER is coded in the dataframe
sprout$SiteID<-gsub("STEER Basin", "STEER", sprout$SiteID)


#filter the props by species
LARA<-sprout%>%filter(Species=="LARA")
AVGE<-sprout%>%filter(Species=="AVGE")

#some of the widths were measured in cm, convert to mm 
AVGE<-AVGE%>%
  mutate(`Width-mm`=if_else(`Width-mm`<7, `Width-mm`*10, `Width-mm`))

# i think these were likely accidentally measured in cm, going to convert to 
LARA<-LARA%>%
  mutate(`Width-mm`=if_else(`Width-mm`<4, `Width-mm`*10, `Width-mm`))

#sprouted as numeric
AVGE$sprouted<-as.numeric(AVGE$sprouted)
LARA$sprouted<-as.numeric(LARA$sprouted)

#intake radicle length as numeric
AVGE$`IntakeRadicleLength-cm`<-as.numeric(AVGE$`IntakeRadicleLength-cm`)


#sproutdate and intake date as dates
sprout$SproutDate<-mdy(sprout$SproutDate)
sprout$IntakeDate<-mdy(sprout$IntakeDate)
sprout$RemovalDate<-mdy(sprout$RemovalDate)


sproutcheck<-sprout%>%
  filter(sprouted==0)

unique(sproutcheck$ReasonForRemoval)

#we have an AVGE NA for reason for removal, but notes show that the prop was really removed because it was moldy so going to fix
sprout$ReasonForRemoval[is.na(sprout$ReasonForRemoval) & sprout$sprouted == 0 & sprout$Species=="AVGE"] <- "mold"

#LARA NA is from Unknown reason
sprout$ReasonForRemoval[is.na(sprout$ReasonForRemoval) & sprout$sprouted == 0 & sprout$Species=="LARA"] <- "UKN"

#there are some instances where prop is marked removed dead, but noted that it was moldy in notes column, 

moldcheck<-sprout %>%
  filter(ReasonForRemoval == "dead",
         grepl("mold", notes, ignore.case = TRUE)) %>%
  select(ReasonForRemoval, notes)


#i'm going to reclassify these as moldy in reason for removal
sprout <- sprout %>%
  mutate(ReasonForRemoval = if_else(
    ReasonForRemoval == "dead" &
      grepl("mold", notes, ignore.case = TRUE),
    "mold",
    ReasonForRemoval
  ))


#this is taking sprout and organizing by species and treatment so I can see how many in each treatment were removed for each reason
totalprops<-sprout%>%
  group_by(Species, Treatment, ReasonForRemoval)%>%
  summarise(N=n())%>%
  pivot_wider(names_from = ReasonForRemoval , values_from = N )

#when i pivot wider, na's show up in columns with no props that were removed for that reason, make zero
totalprops[is.na(totalprops)]<-0

#calculating percentages of total props in each removal/sprouting category (NA in reason for removal means sprouted)
totalprops<-totalprops%>%
  mutate(TotalProps=(UKN+dead+mold+`NA`+`experiment end`+lost+predation))%>%
  mutate(LUNK=(lost+UKN))%>%
  mutate(Pdead=dead/TotalProps, Pmold=mold/TotalProps, Psprout=`NA`/TotalProps, pend=`experiment end`/TotalProps, PPred=predation/TotalProps, PUnk=LUNK/TotalProps)%>%
  select(Species, Treatment, dead, Pdead, mold, Pmold) #I changed out the values in this bottom line to filter for each reason for removal, to make it easier to pull the info for the tables

```

still want to fix the colors in this plot, later later 

Stacked Barplot different removal reasons 
```{r}
library(patchwork)
library(colorBlindness)

totalpropsplot<-sprout%>%
  group_by(Species, Treatment, ReasonForRemoval)%>%
  summarise(N=n())

#combine lost and unknown reasons for removal
totalpropsplot$ReasonForRemoval[totalpropsplot$ReasonForRemoval %in%
                   c("UKN", "lost")] <- "Censored"

#re-code NA as sprouted
totalpropsplot$ReasonForRemoval[is.na(totalpropsplot$ReasonForRemoval)] <- "Sprouted"

totalpropsplot$Treatment<-factor(totalpropsplot$Treatment, levels=c("Fresh", "Salt", "Soil", "Air"))

totalpropsplot$ReasonForRemoval<-factor(totalpropsplot$ReasonForRemoval, levels=c("Censored","experiment end","dead","predation","mold","Sprouted"))

removalplotLARA<-totalpropsplot%>%
  filter(Species=="LARA")%>%
  ggplot(aes(x=Treatment, y=N, fill=ReasonForRemoval))+
  geom_col(position="stack")+
  ylab("Number of Propagules")+
  ggtitle(expression(italic("L. racemosa")))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values=c("Censored"="#001400","experiment end"="#40826D", "dead"="salmon4","predation"="olivedrab","mold"="darkolivegreen1","Sprouted"="#355E3B"), labels=c("Censored"="Censored","experiment end"="Experiment End", "dead"="Dead","predation"="Predation","mold"="Mold","Sprouted"="Sprouted"),name="Reason for Removal")

removalplotLARA

removalplotAVGE<-totalpropsplot%>%
  filter(Species=="AVGE")%>%
  ggplot(aes(x=Treatment, y=N, fill=ReasonForRemoval))+
  geom_col(position="stack")+
  ylab("Number of Propagules")+
  ggtitle(expression(italic("A. germinans")))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values=c("Censored"="#001400","dead"="salmon4","mold"="darkolivegreen1","Sprouted"="#355E3B"), labels=c("Censored"="Censored", "dead"="Dead","mold"="Mold","Sprouted"="Sprouted"),name="Reason for Removal")
  

"#738F52"
"#228B22"
"#889682"
"#355E3B"
"#808000"
"#93C572"
"#009E60"
"#40826D"
"darkgreen"
"salmon4"
"olivedrab"
"burlywood4"

removalplotAVGE

removalplot<-removalplotLARA+removalplotAVGE
removalplot

cvdPlot(removalplot)

```


We see that there are different reasons that the props left the experiment, now investigating the timing on these things and their effect on sprouting using competing risks analysis 

source walking through different types of survival analysis (r tutorial)

competing risks is section 9.3
https://modernstatisticswithr.com/survivalchapter.html

Paper explaining how to interpret the results

Austin, P. C., & Fine, J. P. (2017). Practical recommendations for reporting F ineâ€G ray model analyses for competing risk data. Statistics in medicine, 36(27), 4391-4400.


#another source for competing risks 
https://www.publichealth.columbia.edu/research/population-health-methods/competing-risk-analysis?utm_source=chatgpt.com 

```{r}
library(riskRegression)
library(cmprsk)

#look at unique values in reason for removal
unique(sprout$ReasonForRemoval)

#combine UKN and lost together
sprout$ReasonForRemoval[sprout$ReasonForRemoval %in%
                   c("UKN", "lost")] <- "Not Noted"

#filtering to check and make sure all the NAs in Reason for removal are props that sprouted 
sproutcheck<-sprout%>%
  filter(is.na(ReasonForRemoval))

unique(sproutcheck$sprouted)
#only 1s, so they all sprouted

#ones with NA in reason for removal are all sprouted, recoding sprouted
sprout$ReasonForRemoval[is.na(sprout$ReasonForRemoval)] <- "Sprouted"

#check
unique(sprout$ReasonForRemoval)


#making a fate column coding each fate of the props with a number 
#0 = censored (still unsprouted at day 30)
#1 = sprouted (event of interest)
#2 = mold
#3 = predated
#4 = death
#0 = lost / unknown (this is also data that is censored)

sprout<-sprout%>%
  mutate(Fate=case_when(
     ReasonForRemoval=="experiment end"~0,
    ReasonForRemoval=="Sprouted"~1,
    ReasonForRemoval=="mold"~2,
    ReasonForRemoval=="predation"~3,
    ReasonForRemoval=="dead"~4,
    ReasonForRemoval=="Not Noted"~0,
    
  ))
  
#check to make sure all fates are assigned
unique(sprout$Fate)

sprout$Treatment<-as.factor(sprout$Treatment)

#make a column showing time until either sprouted or removed
sprout<-sprout%>%
  mutate(DaysUntilEvent=  #making a new column
  ifelse(
  is.na(sprout$SproutDate), #if there is an NA in sproutdate
  RemovalDate -IntakeDate,  #then going to subtract removal date (calculates days until removal)
  SproutDate -IntakeDate )) #if there is anything but an NA, then subtract sprout date (calculates days until sprouting)

unique(sprout$DaysUntilEvent)

#found a -1, found NA's, weird gonna look at these
sproutcheck<-sprout%>%
  filter(is.na(DaysUntilEvent)|DaysUntilEvent=="-1"|DaysUntilEvent==0)%>%
  select(Species, Treatment, IntakeDate, SproutDate, RemovalDate,DaysUntilEvent, notes)


#going to remove these NAs and -1, removal date isn't noted for these so they shouldnt be included in analysis
sprout<-sprout%>%
  filter(!is.na(DaysUntilEvent))%>%
  filter(DaysUntilEvent!="-1")

#double check they are removed
unique(sprout$DaysUntilEvent)

#now I'm checking to see if there are any remaining props without a sprout date and a removal date, there are not, but the prop being removed on day zero in the water treatment is weird, investigating more

sproutcheck<-sprout%>%
  filter(is.na(SproutDate)|is.na(RemovalDate))%>%
  select(Treatment,Species,SproutDate, RemovalDate, notes, DaysUntilEvent)%>%
  filter(DaysUntilEvent==0)

#looks like a prop was removed but date wasn't noted, so I am also going to remove this guy from the time series analysis, ok to keep for sprout or no sprout things, only one that has day until event 0 so will remove this row (i actually figured this out because i plotted the data and saw that one had been removed early, this is why its so important to visualize your data!!)

#going to remove these NAs and -1, removal date isn't noted for these so they shouldn't be included in analysis
sprout<-sprout%>%
  filter(DaysUntilEvent!=0)

unique(sprout$DaysUntilEvent)

#data clean and ready to analyse making specific LARAdf for competing risks analysis

LARAcr<-sprout%>%
  filter(Species=="LARA")
#need to turn off tidycmprsk for this to run
cif <- with(LARAcr, cuminc(DaysUntilEvent, Fate, group = Treatment))

str(cif)
#extract the data from one of the curves generated by CIF function
cif[["Air 1"]]
#shows three lists, one for time, one estimates, one variance

extract_cif <- function(cif_obj, name) {

  curve <- cif_obj[[name]]

  # Split name into event and treatment
  parts <- strsplit(name, " ")[[1]]

  data.frame(
    time = curve$time,
    cif  = curve$est,
    event = parts[2],
    treatment = parts[1]
  )
}

#going through to see what this is 
cif_df <- lapply(names(cif), function(nm) {

  if (nm == "Tests") return(NULL)

  extract_cif(cif, nm)

}) %>%
  bind_rows()

#recode events for easier labeling
cif_df <- cif_df %>%
  mutate(
    event = recode(event,
                   "1" = "Sprouted",
                   "2" = "Mold",
                   "3" = "Predated",
                   "4" = "Dead"),
    treatment = factor(treatment)
  )

cifcheck<-cif_df %>%
  group_by(event, treatment) %>%
  filter(time == max(time))

#plot
plotchat<-ggplot(
  cif_df %>% filter(event == "Sprouted"),
  aes(x = time, y = cif, color = treatment)
) +
  geom_step(linewidth = 1.2) +
  labs(
    x = "Days",
    y = "Cumulative probability of sprouting",
    color = "Treatment"
  ) +
  theme_bw(base_size = 14)

plotchat

#repeat plots for all incedence 

```

Checking things make again using a different package
```{r}
library(tidycmprsk)
library(ggsurvfit)
#this package interacts badly with cmprsk, need to turn this off in order to run one from this package
str(LARAcr)

LARAcr$Fate<-as.factor(LARAcr$Fate)
cra<-cuminc(Surv(DaysUntilEvent, Fate) ~ Treatment, data = LARAcr)


LARAplotsprout<-ggcuminc(cra, outcome = c("1"))+
  add_confidence_interval(color=NA)+
  add_risktable()+
  scale_color_manual(name="Treatment",values=c("azure4","cornflowerblue","darkblue","salmon4"))+
  scale_fill_manual(name="Treatment",values=c("azure4","cornflowerblue","darkblue","salmon4"))+
   ggtitle(expression(italic("L. racemosa")))+
  theme(plot.title = element_text(hjust = 0.5))
  
LARAplotsprout

plotmold<-ggcuminc(cra, outcome=c("2"))+
  add_confidence_interval(color=NA)+
  add_risktable()+ 
  scale_color_manual(name="Treatment",values=c("azure4","cornflowerblue","darkblue","salmon4"))+
  scale_fill_manual(name="Treatment",values=c("azure4","salmon4","darkblue","salmon4"))

plotmold



plotPredated<-ggcuminc(cra, outcome=c("3"))
plotPredated

plotDead<-ggcuminc(cra, outcome=c("4"))
plotDead
  

#using this package gives me the same results as what chat taught me! score!
plottt<-plotchat+plotsprout
plottt

```


Now running FineGrey for LARA, this looks at the effect of different explanatory varibles on our outcome we choose 
```{r}
#CIF for sprouting
m1 <- crr(Surv(DaysUntilEvent, Fate) ~ Treatment + Mass+SiteID,
         failcode = "1",
         data = LARAcr)

m1

#Variable                 Coef    SE      HR     95% CI       p-value    
#TreatmentFresh           2.23    0.242   9.28   5.78, 14.9   <0.001     
#TreatmentSalt            1.82    0.233   6.17   3.91, 9.73   <0.001     
#TreatmentSoil            1.24    0.235   3.46   2.18, 5.49   <0.001     
#Mass                     0.668   0.328   1.95   1.02, 3.71   0.042      
#SiteIDSTEER              0.189   0.142   1.21   0.91, 1.60   0.18       
#SiteIDVessup Salt Pond   0.131   0.131   1.14   0.88, 1.47   0.32 


#CIF for mold
m2<-crr(Surv(DaysUntilEvent, Fate) ~ Treatment + Mass+ SiteID,
         failcode = "2",
         data = LARAcr)
m2

#Variable                 Coef     SE      HR     95% CI       p-value    
#TreatmentFresh           -12.9    0.243   0.00   0.00, 0.00   <0.001     
#TreatmentSalt            -12.9    0.251   0.00   0.00, 0.00   <0.001     
#TreatmentSoil            -1.58    0.489   0.21   0.08, 0.54   0.001      
#Mass                     0.508    1.10    1.66   0.19, 14.3   0.64       
#SiteIDSTEER              -0.352   0.548   0.70   0.24, 2.06   0.52       
#SiteIDVessup Salt Pond   -0.034   0.501   0.97   0.36, 2.58   0.95    


#this is a way to export the data directly from r into a table might investigate this more later!
library(gtsummary)
tbl_regression(m1, exponentiate = TRUE)


```

Plotting and Running for AVGE
```{r}

library(ggsurvfit)

#filtering for AVGE
AVGEcr<-sprout%>%
  filter(Species=="AVGE")

unique(AVGEcr$DaysUntilEvent)
unique(AVGEcr$Treatment)
unique(AVGEcr$Fate)

AVGEcr$Fate<-as.factor(AVGEcr$Fate)
Acra<-cuminc(Surv(DaysUntilEvent, Fate) ~ Treatment, data = AVGEcr)
#getting warning message need to investigate!

AVGEplotsprout<-ggcuminc(Acra, outcome = c("1"))+
  add_confidence_interval(color=NA)+
  add_risktable()+ 
  scale_color_manual(name="Treatment",values=c("azure4","cornflowerblue","darkblue","salmon4"))+
  scale_fill_manual(name="Treatment",values=c("azure4","cornflowerblue","darkblue","salmon4"))+
  ggtitle(expression(italic("A. germinans")))+
  theme(plot.title = element_text(hjust = 0.5))
AVGEplotsprout


#combine lara and avge

SproutPlot<-LARAplotsprout/AVGEplotsprout
SproutPlot

#getting a warning, removed 14 rows containint missing values or balues outside scale range need to investigate 
View(plotsprout$data)
#looking at the data I can see that we reach 100% sprouting before the end of the time interval so there are NAs later in the timesteps this is what was removed




plotmold<-ggcuminc(cra, outcome=c("2"))+
  add_confidence_interval(color=NA)+
  add_risktable()+ 
  scale_color_manual(name="Treatment",values=c("azure4","cornflowerblue","darkblue","salmon4"))+
  scale_fill_manual(name="Treatment",values=c("azure4","salmon4","darkblue","salmon4"))

plotmold

plotPredated<-ggcuminc(cra, outcome=c("3"))
plotPredated

plotDead<-ggcuminc(cra, outcome=c("4"))
plotDead
  

str(AVGEcr)
AVGEcr$`IntakeRadicleLength-cm`<-as.numeric(AVGEcr$`IntakeRadicleLength-cm`)

#CIF for sprouting
Am1 <- crr(Surv(DaysUntilEvent, Fate) ~ Treatment + Float+ PropaguleLength+`IntakeRadicleLength-cm`,
         failcode = "1",
         data = AVGEcr)

Am1

#Variable                   Coef     SE      HR     95% CI       p-value    
#TreatmentFresh             4.15     0.314   63.2   34.2, 117    <0.001     
#TreatmentSalt              2.55     0.277   12.8   7.47, 22.1   <0.001     
#TreatmentSoil              2.84     0.320   17.0   9.10, 31.9   <0.001     
#FloatY                     0.288    0.123   1.33   1.05, 1.70   0.019      
#PropaguleLength            0.465    0.208   1.59   1.06, 2.40   0.026      
#`IntakeRadicleLength-cm`   -0.412   0.154   0.66   0.49, 0.90   0.008  


#CIF for mold
Am2<-crr(Surv(DaysUntilEvent, Fate) ~ Treatment + Mass+ SiteID,
         failcode = "2",
         data = AVGEcr)

Am2

#Variable                 Coef     SE      HR     95% CI       p-value    
#TreatmentFresh           -13.1    0.165   0.00   0.00, 0.00   <0.001     
#TreatmentSalt            -3.78    0.713   0.02   0.01, 0.09   <0.001     
#TreatmentSoil            -2.39    0.386   0.09   0.04, 0.20   <0.001     
#Mass                     -0.118   0.215   0.89   0.58, 1.36   0.58       
#SiteIDSTEER              -0.059   0.271   0.94   0.55, 1.60   0.83       
#SiteIDVessup Salt Pond   0.026    0.286   1.03   0.59, 1.80   0.93      


```



Should be ready to rock and roll!


This below is when i thought I would be doing KM, keeping for future me!


Data Cleaning, Kaplein Meyer Curve and Log Rank Test

going to run a kaplin meyer curve analysis to analyze time until sprouting.. 
biostatssquid is a good source to walk through this analysis

The theory behind it all
https://biostatsquid.com/survival-time-analysis-easily-explained/
https://biostatsquid.com/kaplan-meier-curve/
https://biostatsquid.com/easy-log-rank-test/
https://biostatsquid.com/easy-cox-regression-for-survival-analysis/

the code (how to do it)
https://biostatsquid.com/easy-survival-analysis-r-tutorial/ 

another tutorial I like the first one better https://www.sthda.com/english/wiki/survival-analysis-basics
```{r}
library(survival)
library(ggsurvfit)
library(survminer)


#For this analysis we need 
#censoring status: the values in this column are 1 = event happened, 0 = censored (or TRUE and FALSE).

    #this is the sprouted column that we made above, where if it sprotued 1, if       not sprotued 0

#time to event: from the start time (experiment start) to the end time (the event happened or the last day of follow-up (end of thirty day monitoring)

  #to do this I am calculating the days until the props either sprouted, or were      removed

#using an if else statement to do this, 
sprout<-sprout%>%
  mutate(DaysUntilEvent=  #making a new column
  ifelse(
  is.na(sprout$SproutDate), #if there is an NA in sproutdate
  RemovalDate -IntakeDate,  #then going to subtract removal date (calculates days until removal)
  SproutDate -IntakeDate )) #if there is anything but an NA, then subtract sprout date (calculates days until sprouting)

#looking at my new columns to make sure everything is Kosher
unique(sprout$DaysUntilEvent)
#found a -1, found NA's, weird gonna look at these
sproutcheck<-sprout%>%
  filter(is.na(DaysUntilEvent)|DaysUntilEvent=="-1"|DaysUntilEvent==0)%>%
  select(Species, Treatment, IntakeDate, SproutDate, RemovalDate,DaysUntilEvent, notes)


#going to remove these NAs and -1, removal date isn't noted for these so they shouldnt be included in analysis
sprout<-sprout%>%
  filter(!is.na(DaysUntilEvent))%>%
  filter(DaysUntilEvent!="-1")

#double check they are removed
unique(sprout$DaysUntilEvent)

#now I'm checking to see if there are any remaining props without a sprout date and a removal date, there are not, but the prop being removed on day zero in the water treatment is weird, investigating more

sproutcheck<-sprout%>%
  filter(is.na(SproutDate)|is.na(RemovalDate))%>%
  select(Treatment,Species,SproutDate, RemovalDate, notes, DaysUntilEvent)%>%
  filter(DaysUntilEvent==0)

#looks like a prop was removed but date wasn't noted, so I am also going to remove this guy from the time series analysis, ok to keep for sprout or no sprout things, only one that has day until event 0 so will remove this row (i actually figured this out because i plotted the data and saw that one had been removed early, this is why its so important to visualize your data!!)

sprout<-sprout%>%
  filter(DaysUntilEvent!=0)

# data looks clean now, ok to leave a lot of these for binary analysis (sprout not sprout 0/1) but need to remove for time series analysis because don't know date of removal or sprouting

#check how many in each treatment
sproutcheck<-sprout%>%
  group_by(Species, Treatment)%>%
  summarise(n=n())

#Air-175 LARA 88 AVGE 87
#Fresh-177 LARA 89 AVGE 88
#Salt-179 LARA 89 AVGE 90
#Soil-180 LARA 90 AVGE 90


#check to make sure my columns are numeric
str(sprout)
sprout$sprouted<-as.numeric(sprout$sprouted)

#separate the two species into their own dataframes

LARA<-sprout%>%
  filter(Species=="LARA")

AVGE<-sprout%>%
  filter(Species=="AVGE")

#now we create the survival object using these two columns we created in sprout (censoring status=sprouted or not 0/1, and time to event=time until sprouted or was removed)

LARAsurv_obj <- Surv(time = LARA$DaysUntilEvent, event = LARA$sprouted)
AVGEsurv_obj<-Surv(time = AVGE$DaysUntilEvent, event = AVGE$sprouted)

#Log Rank Test (run this so we can plot it)
LARAsurv <- survfit(LARAsurv_obj ~ Treatment, data = LARA)
AVGEsurv<- survfit(AVGEsurv_obj ~ Treatment, data = AVGE)

#plotting LARA (fun=event plots it so it is time until event not number alive over time)
LARAplotobj<-ggsurvplot(LARAsurv, data=LARA,fun="event",
  palette = c("olivedrab","cornflowerblue","darkblue","salmon4"),conf.int = TRUE)

LARAplotobj

#the ggsurvplot() function doesn't just create a plot, it creates a list of things containing the plot, in order to add ggplot layers you have to pull the plot out of the list, then you can add titles and stuff on like normal

LARAplot<-LARAplotobj$plot+ #pulling out the plot from the list
  ggtitle(expression(italic("L. racemosa")))+#adding ggplot things like normal
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
LARAplot

#plotting AVGE
AVGEplotobj<-ggsurvplot(AVGEsurv, data=AVGE,fun="event",#makes it cumulative rather than countdown
  palette = c("olivedrab","cornflowerblue","darkblue","salmon4"),conf.int = TRUE)
AVGEplotobj



#same thing for AVGE
AVGEplot<-AVGEplotobj$plot+ #pulling out the plot from the list
  ggtitle(expression(italic("A. germinans")))+#adding ggplot things like normal
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
AVGEplot

#now time to stat, log rank test to test for statistical differences between the curves

logRankAVGE<-survdiff(Surv(time = AVGE$DaysUntilEvent, event = AVGE$sprouted) ~ Treatment, data = AVGE)

logRankAVGE

#Call:
#survdiff(formula = Surv(time = AVGE$DaysUntilEvent, event = AVGE$sprouted) ~ 
#    Treatment, data = AVGE)

#                 N Observed Expected (O-E)^2/E (O-E)^2/V
#Treatment=Air   87       14     98.9    72.884   136.362
#Treatment=Fresh 88       88     28.0   128.905   173.473
#Treatment=Salt  90       88     82.6     0.359     0.592
#Treatment=Soil  90       77     57.6     6.551     9.480

# Chisq= 257  on 3 degrees of freedom, p= <2e-16

#so we are looking at the number of samples in each treatment, the number that were observed to sprout, the number that would be expected if all treatments were the same, and the difference between observed and expected



LogRankLARA<-survdiff(Surv(time = LARA$DaysUntilEvent, event = LARA$sprouted) ~ Treatment, data = LARA)
print(LogRankLARA)

#survdiff(formula = Surv(time = LARA$DaysUntilEvent, event = LARA$sprouted) ~ 
#    Treatment, data = LARA)

#                 N Observed Expected (O-E)^2/E (O-E)^2/V
#Treatment=Air   88       26     90.9    46.355     89.43
#Treatment=Fresh 89       85     41.6    45.375     70.18
#Treatment=Salt  89       84     54.7    15.662     24.59
#Treatment=Soil  90       66     73.8     0.822      1.37

# Chisq= 144  on 3 degrees of freedom, p= <2e-16 

#now that we know there is a difference between treatments want to take into account the other variables use a Cox regression analysis to incorporate 

#so we are looking at the number of samples in each treatment, the number that were observed to sprout, the number that would be expected if all treatments were the same, and the difference between observed and expected
```


Cox Regression (did not finish running both because looking into different analysis)
``` {r}
#looking at the structure of the dataframe and reclassifying things
str(LARA)
LARA$Float<-as.factor(LARA$Float)
LARA$Treatment<-as.factor(LARA$Treatment)
LARA<-as.data.frame(LARA)
LARA$SiteID<-as.factor(LARA$SiteID)

str(LARA)

#now that we know there is a difference between treatments want to take into account the other variables use a Cox regression analysis to incorporate 

#using a size characteristic, siteID, and Treatment
#not going to include float because they all basically flaoted

LARAcox<-coxph(Surv(time = LARA$DaysUntilEvent, event = LARA$sprouted)~Treatment+SiteID+Mass, data=LARA)

LARAcox
#Call:
#coxph(formula = Surv(time = LARA$DaysUntilEvent, event = LARA$sprouted) ~ 
#    Treatment + SiteID + Mass, data = LARA)

#                          coef exp(coef) se(coef)      z        p
#TreatmentFresh          2.3905   10.9194   0.2337 10.231  < 2e-16
#TreatmentSalt           1.8740    6.5145   0.2317  8.090 5.98e-16
#TreatmentSoil           1.2685    3.5554   0.2329  5.445 5.17e-08
#SiteIDSTEER             0.2101    1.2338   0.1568  1.339  0.18042
#SiteIDVessup Salt Pond  0.1666    1.1813   0.1610  1.035  0.30085
#Mass                    0.7547    2.1270   0.2678  2.818  0.00483

#Likelihood ratio test=154.3  on 6 df, p=< 2.2e-16
#n= 356, number of events= 261 

summary(LARAcox)
#this is the output of the cox regression

#now testing cox proportional hazards 
fit <- coxph(Surv(DaysUntilEvent, sprouted) ~ Treatment + SiteID + Mass,
             data = LARA)

ph_test <- cox.zph(fit)
print(ph_test)


AVGEcox<-coxph(Surv(time = AVGE$DaysUntilEvent, event = AVGE$sprouted)~Treatment+SiteID+Mass+Float, data=AVGE)

AVGEcox
```

Look at if the number of moldy seeds are different among treatments. Doing this because my analysis above is censoring the data based on if seeds are removed because they died or are moldy. If the censoring is unequal across treatments then I might need to run a competing risk analysis

```{r Checking Censoring}
library(tidyverse)

#looking at total number of props
totalprops<-sprout%>%
  group_by(Species, Treatment, ReasonForRemoval)%>%
  summarise(N=n())%>%
  pivot_wider(names_from = ReasonForRemoval , values_from = N )

totalprops[is.na(totalprops)]<-0

totalprops<-totalprops%>%
  mutate(TotalProps=(UKN+dead+mold+`NA`+`experiment end`+lost+predation))%>%
  mutate(LUNK=(lost+UKN))%>%
  mutate(Pdead=dead/TotalProps, Pmold=mold/TotalProps, Psprout=`NA`/TotalProps, pend=`experiment end`/TotalProps, PPred=predation/TotalProps, PUnk=LUNK/TotalProps)%>%
  select(Species, Treatment, Psprout)

#looking at reasons for removal 
unique(sprout$ReasonForRemoval)
#[1] NA   "mold"   "dead"   "UKN"    "experiment end"  "lost"    [7] "predation"


#alot that are NA in reason for removal, so I want to look at these looking separately at the props that sprouted and the ones that didnt
nosproutcheck<-sprout%>%
  filter(sprouted==1)

unique(nosproutcheck$ReasonForRemoval)
#all NAs, they were removed because they sprouted


#now looking at the ones that did not sprout,want to check notes
sproutcheck<-sprout%>%
  filter(sprouted==0)

unique(sproutcheck$ReasonForRemoval)

#we have an NA here for reason for removal, but notes show that the prop was really removed because it was moldy so going to fix
sprout$ReasonForRemoval[is.na(sprout$ReasonForRemoval) & sprout$sprouted == 0] <- "mold"

#looking at total number removed and for what reason in each treatment
sproutcheck<-sprout%>%
  filter(sprouted==0)%>%
  group_by(Species,Treatment, ReasonForRemoval)%>%
  summarise(Number=n())%>%
  pivot_wider(names_from = ReasonForRemoval , values_from = Number )

sproutcheck[is.na(sproutcheck)]<-0

sproutcheck<-sproutcheck%>%
  mutate(TotalDead=sum(UKN+dead+mold+`experiment end`+lost))%>%
  mutate(BeforeEnd=sum(UKN+dead+mold+lost))

#these numbers are different across treatments, so I need to run a different analysis, I might need to look at this separately

```


Running Competing Risks Analysis

https://psiaims.github.io/CAMIS/R/survival_cif.html 


why competing risks analysis is necessary
https://www.bing.com/videos/riverview/relatedvideo?q=competing+risk+analysis+in+time+to+event&mid=C047AF3DB52ABDFA9ED1C047AF3DB52ABDFA9ED1&FORM=VIRE 
```{r}
library(tidyverse)
library(cmprsk)
library(survminer)


#setting a column that sets the status, whether the prop survived to the end 0, was pulled due to mold/predation/death 2, or sprouted 1

sprout<-sprout%>%
  mutate(status= case_when(
    sprouted == 1 ~ 1,
    sprouted == 0 & ReasonForRemoval != "experiment end" ~ 2,
    sprouted == 0 & ReasonForRemoval == "experiment end" ~ 0
  ))

unique(sprout$status)

LARA<-sprout%>%
  filter(Species=="LARA")%>%
  select(Treatment,DaysUntilEvent, status)

AVGE<-sprout%>%
  filter(Species=="AVGE")

LARA$status<-as.factor(LARA$status)

#run CIF

LARAcif <- cuminc(Surv(DaysUntilEvent, status)~Treatment, data=LARA)
LARAcif


plot(cif, curvlab = names(cif), xlab = "Days", ylab = "Cumulative incidence", col = c("blue","red","green"))
legend("bottomright", legend = c("Sprout", "Mold/Death", "Censored"), col = c("blue","red","green"), lty=1)
```



